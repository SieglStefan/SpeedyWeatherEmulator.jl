<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Examples · SpeedyWeatherEmulator.jl</title><meta name="title" content="Examples · SpeedyWeatherEmulator.jl"/><meta property="og:title" content="Examples · SpeedyWeatherEmulator.jl"/><meta property="twitter:title" content="Examples · SpeedyWeatherEmulator.jl"/><meta name="description" content="Documentation for SpeedyWeatherEmulator.jl."/><meta property="og:description" content="Documentation for SpeedyWeatherEmulator.jl."/><meta property="twitter:description" content="Documentation for SpeedyWeatherEmulator.jl."/><meta property="og:url" content="https://SieglStefan.github.io/SpeedyWeatherEmulator.jl/examples/"/><meta property="twitter:url" content="https://SieglStefan.github.io/SpeedyWeatherEmulator.jl/examples/"/><link rel="canonical" href="https://SieglStefan.github.io/SpeedyWeatherEmulator.jl/examples/"/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">SpeedyWeatherEmulator.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../running_SWE/">Running SpeedyWeatherEmulator.jl</a></li><li class="is-active"><a class="tocitem" href>Examples</a><ul class="internal"><li><a class="tocitem" href="#Hyperparameter-Optimization"><span>Hyperparameter Optimization</span></a></li><li><a class="tocitem" href="#Long-Forecast-Quality"><span>Long Forecast Quality</span></a></li><li><a class="tocitem" href="#Rossby-Haurwitz-wave"><span>Rossby-Haurwitz wave</span></a></li></ul></li><li><a class="tocitem" href="../functions_index/">Functions &amp; Types index</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Examples</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Examples</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/SieglStefan/SpeedyWeatherEmulator.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/SieglStefan/SpeedyWeatherEmulator.jl/blob/main/docs/src/examples.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Examples"><a class="docs-heading-anchor" href="#Examples">Examples</a><a id="Examples-1"></a><a class="docs-heading-anchor-permalink" href="#Examples" title="Permalink"></a></h1><p>This section provides explanation of code used to produce the results presented in the project report, along with additional examples and outputs. The plotting routines themselves are not listed here, but interested readers can find the corresponding code under the folder <a href="https://github.com/SieglStefan/SpeedyWeatherEmulator.jl/tree/main/examples"><code>examples</code></a> in the repository. In addition, the actual code is structured somewhat differently (e.g., the separation into performance and evaluation parts) from the simplified demonstrations shown in this documentation. Nevertheless, the scripts are extensively commented, making them straightforward to follow.</p><p>The <a href="https://github.com/SieglStefan/SpeedyWeatherEmulator.jl/blob/main/ProjectReport.pdf">Project Report</a> provides a quick overview of the examples without code snippets. Furthermore, it briefly introduces the necessity and background of emulators and explains and discusses the results, which is not done here.</p><h2 id="Hyperparameter-Optimization"><a class="docs-heading-anchor" href="#Hyperparameter-Optimization">Hyperparameter Optimization</a><a id="Hyperparameter-Optimization-1"></a><a class="docs-heading-anchor-permalink" href="#Hyperparameter-Optimization" title="Permalink"></a></h2><p>First, a hyperparameter optimization (width and depth of the neural network) is performed, consisting of a coarse and fine optimization.</p><h3 id="Data-Generation"><a class="docs-heading-anchor" href="#Data-Generation">Data Generation</a><a id="Data-Generation-1"></a><a class="docs-heading-anchor-permalink" href="#Data-Generation" title="Permalink"></a></h3><p>For this purpose, the simulation parameters <code>sim_para</code> are defined, raw data is generated and stored, and the corresponding simulation data <code>sim_data</code> produced and saved. In all subsequent examples, these <code>sim_data</code> is used directly, so the raw data is no longer required and can be deleted if desired (e.g. storage reasons). The data is then further formatted into data pairs:</p><pre><code class="language-julia hljs"># Define simulation parameters
const TRUNC = 5
const N_DATA = 48
const N_IC = 1000

sim_para = SimPara(trunc=TRUNC, n_data=N_DATA, n_ic=N_IC)

# Generate raw data
generate_raw_data(sim_para)

# Generate simulation data and save it
sim_data = SimData(sim_para)
save_data(sim_data)

# Generate formatted data
fd = FormattedData(sim_data)</code></pre><h3 id="Coarse-Optimization"><a class="docs-heading-anchor" href="#Coarse-Optimization">Coarse Optimization</a><a id="Coarse-Optimization-1"></a><a class="docs-heading-anchor-permalink" href="#Coarse-Optimization" title="Permalink"></a></h3><p>We first perform a coarse optimization using the following values for depth (L) and width (W):</p><pre><code class="language-julia hljs">L_list_coarse = [1,2,3]                 # depth: number of hidden layers
W_list_coarse = [64, 128, 256, 512]     # width: number of neurons per hidden layer</code></pre><p>Next, we run a short and simple initial training using <code>nn_warmup</code> to ensure that the time logging is not distorted:</p><pre><code class="language-julia hljs">nn_warmup = NeuralNetwork(io_dim=2*calc_n_coeff(trunc=TRUNC),
                          hidden_dim=8,
                          n_hidden=1)

_, _ = train_emulator(nn_warmup, fd; n_epochs=1)</code></pre><p>After this initial warm-up, we are now ready to train the emulators for the different depths and widths. A total of 12 combinations are tested. This is computationally intensive and may take several hours on simple standard machines. Therefore, the emulators and losses are also saved for later use, so that the optimization does not need to be repeated.</p><pre><code class="language-julia hljs"># Training loop
for L in L_list_coarse, W in W_list_coarse

    # Define simulation parameters for specific hyperparameter
    id = &quot;_hyperpara_L$(L)_W$(W)&quot;
    sim_para = SimPara(trunc=TRUNC, n_data=N_DATA, n_ic=N_IC, id_key=id)

    # Define neural network and train the emulator
    nn = NeuralNetwork( io_dim=2*calc_n_coeff(trunc=TRUNC),
                        hidden_dim = W,
                        n_hidden = L)

    em, losses = train_emulator(nn, fd; sim_para=sim_para)

    # Save losses and data for later evaluation
    save_data(em)
    save_data(losses)
end</code></pre><p>Next, we define a function <code>n_params</code> to calculate the total number of parameters of a neural network. In addition, we define a dictionary <code>plot_data</code> to conveniently store plotting data for different (L, W) combinations:</p><pre><code class="language-julia hljs">n_params(d, W, L) = (d*W + W) + (L-1)*(W*W + W) + (W*d + d)

plot_data = Dict{Tuple{Int,Int}, NamedTuple}()      </code></pre><p>Next, we want to populate the dictionary with the relative errors for various forecast times (horizons) and the total number of parameters for all (L,W) combinations:</p><pre><code class="language-julia hljs"># Define comparing time horizons
horizons = [1, 6, 12, 24]

# Fill the plot data dict. for all coarse hyperparameter
for L in L_list_coarse, W in W_list_coarse

    # Define simulation parameters for specific hyperparameter for leading specific emulator
    id = &quot;_hyperpara_L$(L)_W$(W)&quot;
    sim_para = SimPara(trunc=TRUNC, n_data=N_DATA, n_ic=N_IC, id_key=id)

    # Load the specific emulator (generated by training loop above)
    em = load_data(Emulator, sim_para)

    # Define container for rel. errors for different horizons
    err_vec = zeros(N_DATA)

    # Compare the emulator for different horizons
    for steps in horizons
        err_vec[steps] = compare_emulator(  em,
                                            x_test=fd.data_pairs.x_valid,
                                            y_test=fd.data_pairs.y_valid,
                                            n_it=steps)

    end

    # Fill the dict
    plot_data[(L,W)] = (err=err_vec, params=n_params(2*calc_n_coeff(trunc=TRUNC), W, L))
end</code></pre><p>These results are then plotted:</p><p><img src="../assets/examples/opt_coarse.png" alt="Coarse Optimization"/></p><p>The code for generating the plots can be found in the package repository.</p><h3 id="Fine-Optimization"><a class="docs-heading-anchor" href="#Fine-Optimization">Fine Optimization</a><a id="Fine-Optimization-1"></a><a class="docs-heading-anchor-permalink" href="#Fine-Optimization" title="Permalink"></a></h3><p>Next, a finer optimization is performed around the best value from the coarse search (L = 1, W = 512) using the following values:</p><pre><code class="language-julia hljs">L_list_fine = [1]                           # depth: number of hidden layers
W_list_fine = [384, 512, 640, 768, 896, 
                1024, 1280, 1536, 2048]     # width: number of neurons per hidden layer</code></pre><p>The procedure is very similar and is not repeated here. Interested readers can find the details in the repository. The results are plotted again:</p><p><img src="../assets/examples/opt_fine.png" alt="Fine Optimization"/></p><p>For later applications, the combination (L = 1, W = 640) is chosen as the best parameters, as it provides the best compromise between emulator quality and training time. This combination is also the default for the <code>NeuralNetwork</code> object.</p><h3 id="Parameters-vs.-Time"><a class="docs-heading-anchor" href="#Parameters-vs.-Time">Parameters vs. Time</a><a id="Parameters-vs.-Time-1"></a><a class="docs-heading-anchor-permalink" href="#Parameters-vs.-Time" title="Permalink"></a></h3><p>In the plots above, emulator quality was shown against the total number of parameters of the neural network. This raises the further question of how the different (L, W) combinations perform in terms of time. A good emulator should provide high prediction quality but should also not take excessively long to train. How, then, are training time and parameter count related? To investigate this, training time versus parameter count is plotted:</p><p><img src="../assets/examples/opt_paras_time.png" alt="Parameters vs time"/></p><p>A clear linear correlation can be observed. Training time and parameter count are therefore essentially synonymous. The corresponding code is again available in the repository.</p><h2 id="Long-Forecast-Quality"><a class="docs-heading-anchor" href="#Long-Forecast-Quality">Long Forecast Quality</a><a id="Long-Forecast-Quality-1"></a><a class="docs-heading-anchor-permalink" href="#Long-Forecast-Quality" title="Permalink"></a></h2><p>Next, the prediction quality for different forecast lengths is examined in more detail. For this purpose, we use the simulation data generated during the <a href="#hyperparameter-optimization">Hyperparameter Optimization</a> by loading the stored data and subsequently formatting them:</p><pre><code class="language-julia hljs"># Load and format simulation data, generated by the hyperparameter optimization
const TRUNC = 5
const N_DATA = 48
const N_IC = 1000

sim_para_loading = SimPara(trunc=TRUNC, n_data=N_DATA, n_ic=N_IC)
sim_data = load_data(SimData, sim_para_loading)
fd = FormattedData(sim_data)</code></pre><p>Next, the best emulator from the hyperparameter optimization (L = 1, W = 640) is loaded. For this purpose, a <code>separate sim_para_emulator</code> must be defined:</p><pre><code class="language-julia hljs"># Loading the best emulator from the hyperparameter optimiaztion
sim_para_emulator = SimPara(trunc=TRUNC, n_data=N_DATA, n_ic=N_IC, id_key=&quot;_hyperpara_L1_W640&quot;)
em = load_data(Emulator, sim_para_emulator)</code></pre><p>Then, the data vectors <code>err_vec</code> and <code>err_vec0</code> storing rel. errors are defined. <code>err_vor</code> simply contains the averaged relative error of the emulator for different horizons, while <code>err_vor0</code> contains the averaged relative error of the identity emulator. Thus, err_vec0 represents the relative error between <span>$\mathrm{vor}(t + \mathrm{steps})$</span> and <span>$\mathrm{vor}(t)$</span> as a measure of the actual change in vorticity for comparison.</p><pre><code class="language-julia hljs"># Calculate the rel. errors 
for steps in 1:N_DATA
    err_vec[steps] = compare_emulator(  em,
                                        x_test=fd.data_pairs.x_test,
                                        y_test=fd.data_pairs.y_test,
                                        n_it=steps)
    err_vec0[steps] = compare_emulator( em,
                                        x_test=fd.data_pairs.x_test,
                                        y_test=fd.data_pairs.y_test,
                                        n_it=steps,
                                        id_em=true)     # identy emulator (em(vor) = vor)
end</code></pre><p>Different values for the maximum forecast length (here <code>N_DATA</code>) can of course also be used. This data is now plotted again:</p><p><img src="../assets/examples/LF_em_qual.png" alt="Long forecast emulator quality"/></p><p><img src="../assets/examples/LF_em_comp.png" alt="long forecast emulator comparison"/></p><p>For further details, see the repository and/or project report. </p><h3 id="Heatmap-Plots"><a class="docs-heading-anchor" href="#Heatmap-Plots">Heatmap Plots</a><a id="Heatmap-Plots-1"></a><a class="docs-heading-anchor-permalink" href="#Heatmap-Plots" title="Permalink"></a></h3><p>Next, we create a visual representation of emulator quality using <code>plot_heatmap</code>. To this end, we select the forecast horizons to be plotted and extract corresponding vorticity vectors by specifying the index of the initial condition <code>ic</code>.</p><pre><code class="language-julia hljs"># Define the time horizons for comparison and used initial condition
horizons = [1, 6, 24, 48]
ic = 6</code></pre><p>(Here, ic = 6 was chosen because its vorticity vectors produce clear plots.) We then compute the target and emulated vorticity step by step and plot the corresponding heatmaps:</p><pre><code class="language-julia hljs"># Loop for different time horizons
for h in horizons
    # Initial vorticity
    vor0 = sim_data.data[:, 1, ic]

    # Target (SpeedyWeather.jl) and emulated vorticity
    vor_sw = sim_data.data[:, h, ic]
    vor_em = vor0

    for _ in 1:h
        vor_em = em(vor_em)
    end

    # Create heatmap plots
    colorrange = (-2.5e-5, +2.5e-5)
    fig_sw = plot_heatmap(vor_sw, trunc=5, title=&quot;&quot;, range=colorrange)
    fig_em = plot_heatmap(vor_em, trunc=5, title=&quot;&quot;, range=colorrange)
end</code></pre><p>This results in many individual heatmaps. These heatmaps are not shown here but were subsequently combined into a single large figure using Inkscape:</p><p><img src="../assets/examples/LF_heatmap.png" alt="Long forecast heatmap"/></p><p>For further details, see the repository and/or project report. </p><h2 id="Rossby-Haurwitz-wave"><a class="docs-heading-anchor" href="#Rossby-Haurwitz-wave">Rossby-Haurwitz wave</a><a id="Rossby-Haurwitz-wave-1"></a><a class="docs-heading-anchor-permalink" href="#Rossby-Haurwitz-wave" title="Permalink"></a></h2><p>So far, the emulator has only been tested on random initial conditions, i.e., on data with the same structure it was trained on. We now want to examine how the emulator responds to special cases. For this purpose, we consider the Rossby–Haurwitz wave, which propagates steadily around the Earth. Thus, we define the Rossby–Haurwitz initial state as the initial condition:</p><pre><code class="language-julia hljs"># Define Rossby-Haurwitz wave initial condiion
m = 4
ω = 7.848e-6
K = 7.848e-6

ζ(λ, θ, σ) = 2ω*sind(θ) - K*sind(θ)*cosd(θ)^m*(m^2 + 3m + 2)*cosd(m*λ)</code></pre><p>This code snippet was taken from the documentation of <code>SpeedyWeatherEmulator.jl</code>, which in turn refers to the paper ‘A standard test set for numerical approximations to the shallow water equations in spherical geometry’ by David L. Williamson, John B. Drake, James J. Hack, Rüdiger Jakob, and Paul N. Swarztrauber. See the project report for details on references.</p><p>With this initial condition defined, we can now generate simulation data for comparison. To do so, the initial condition must be passed to <code>SimPara</code>, which then forwards it to <code>generate_raw_data</code>, where <code>SpeedyWeather.jl</code> uses it to generate data. Subsequently, the data is formatted again. Since we only require test data, the splits are set to <code>splits = (0, 0, 1)</code>:</p><pre><code class="language-julia hljs"># Define test data
sim_para_RH = SimPara(trunc=5, n_data=48, n_ic=1, initial_cond=ζ, id_key=&quot;_RH_wave&quot;, n_spinup=0)
generate_raw_data(sim_para_RH)
sim_data_RH = SimData(sim_para_RH)
fd_RH = FormattedData(sim_data_RH, splits=(train=0, valid=0, test=1))</code></pre><p>The subsequent procedure is analogous to <a href="#Long-Forecast-Quality">Long Forecast Quality</a>. An emulator is loaded, the relative errors are computed, and the data is plotted. See the repository and/or project report for details. The resulting plots are shown below:</p><p><img src="../assets/examples/RH_em_comp.png" alt="RH emulator comparison"/></p><p><img src="../assets/examples/RH_heatmap.png" alt="RH Heatmap"/></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../running_SWE/">« Running SpeedyWeatherEmulator.jl</a><a class="docs-footer-nextpage" href="../functions_index/">Functions &amp; Types index »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.14.1 on <span class="colophon-date" title="Tuesday 9 September 2025 19:19">Tuesday 9 September 2025</span>. Using Julia version 1.11.6.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
